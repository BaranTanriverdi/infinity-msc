name: ML System Card Generator

on:
  workflow_dispatch:
    inputs:
      runId:
        description: "Unique run identifier (e.g., run-2025-11-08_2130)"
        required: true
        type: string
      baseSha:
        description: "Base commit SHA for incremental analysis"
        required: true
        type: string

concurrency:
  group: ml-system-card-generator-${{ github.ref }}-${{ inputs.runId }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  generate:
    name: Draft proposal
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: scripts/package-lock.json

      - name: Install script dependencies
        run: npm ci --prefix scripts

      - name: Build workflow utilities
        run: npm run build --prefix scripts

      - name: Debug Build Output
        run: ls -R scripts/dist

      - name: Generate proposal
        env:
          RUN_ID: ${{ inputs.runId }}
          BASE_SHA: ${{ inputs.baseSha }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY || secrets.OPENAI_API_KEY }}
          LLM_MODEL: "gpt-5.1"
          LLM_PROVIDER: "openai"
          LLM_ENABLED: "true"
          LLM_DRY_RUN: "false"
        run: |
          npm run workflow:generator --prefix scripts -- --run-id "$RUN_ID" --base-sha "$BASE_SHA"
          npm run workflow:metrics --prefix scripts -- --runId "$RUN_ID" --stage generator

      - name: Commit proposal artifact
        env:
          RUN_ID: ${{ inputs.runId }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Add files first so we can detect new vs modified
          git add docs/.proposals
          [ -d docs/.metrics ] && git add docs/.metrics || true

          if git diff --staged --quiet; then
            echo "No proposal changes to commit"
            exit 0
          fi

          git commit -m "chore(card): record proposal ${RUN_ID}"

          # If we are on main/master, create a new branch and PR
          CURRENT_BRANCH=$(git branch --show-current)
          if [[ "$CURRENT_BRANCH" == "master" || "$CURRENT_BRANCH" == "main" ]]; then
             echo "Detected run on default branch. creating PR..."
             NEW_BRANCH="proposal/${RUN_ID}"
             git checkout -b "$NEW_BRANCH"
             git push origin "$NEW_BRANCH"
             gh pr create --title "chore(card): Proposal ${RUN_ID}" --body "Automated proposal generated by ML System Card." --base "$CURRENT_BRANCH" --head "$NEW_BRANCH"
          else
             # Otherwise just push to the active branch (assuming existing PR or feature branch)
             git push
          fi

      - name: Upload Proposal Artifact
        uses: actions/upload-artifact@v4
        with:
          name: proposal-${{ inputs.runId }}
          path: |
            docs/.proposals/${{ inputs.runId }}.json
            docs/.metrics/${{ inputs.runId }}.metrics.json
          if-no-files-found: warn

      - name: Post coverage summary
        if: always()
        env:
          RUN_ID: ${{ inputs.runId }}
        run: npm run workflow:post-summary --prefix scripts -- "$RUN_ID"
